#!/usr/bin/env php
<?php

declare(strict_types=1);

use App\Infrastructure\Command\ConsumeMessagesCommand;
use DI\ContainerBuilder;
use Psr\Container\ContainerInterface;
use Symfony\Component\Console\Application;
use Symfony\Component\Console\CommandLoader\ContainerCommandLoader;
use Symfony\Component\Messenger\Command\ConsumeMessagesCommand;
use Symfony\Component\Messenger\Command\DebugCommand;

if ('cli' !== PHP_SAPI) {
    die('This is only accessible through console.');
}

require __DIR__ . '/../vendor/autoload.php';

$containerBuilder = new ContainerBuilder();

try {
    /** @var ContainerInterface $container */
    $container = (new ContainerBuilder())->build();

    /** @var Application $application */
    $application = $container->get(Application::class);

    // Register symfony messenger commands here
    $lazyLoaderCommands = new ContainerCommandLoader(
        $container,
        [
            'reservation:fulfill' => ConsumeMessagesCommand::class
        ]
    );

    $application->setCommandLoader($lazyLoaderCommands);

    exit($application->run());
} catch (Throwable $exception) {
    echo $exception->getMessage();
    exit(1);
}

